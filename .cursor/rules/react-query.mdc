---
description: React Query 和 Hooks 开发规范 - 适用于 hooks 目录下的文件
globs:
  - hooks/**/*.ts
  - hooks/**/*.tsx
---

# React Query Hooks 规范

> **重要**: 页面必须通过 Hooks 调用 Server Actions，禁止直接使用 fetch('/api/...')

## 文件规范

- **位置**: `hooks/` 目录
- **命名**: `use-{domain}.ts`（如 `use-checkins.ts`）

## 标准模板

```typescript
// 1. React
import { useCallback, useMemo, useState } from "react";

// 2. Third-party
import { useMutation, useQuery, useQueryClient } from "@tanstack/react-query";
import { toast } from "sonner";

// 3. Server Actions
import {
  listEntitiesAction,
  createEntityAction,
  updateEntityAction,
  deleteEntityAction,
} from "@/server/actions/entityAction";

// 4. Types
import type { Entity, EntityFormData } from "@/types/entity-types";

export function useEntities() {
  const queryClient = useQueryClient();

  // ✅ 使用 React Query 获取数据（调用 Server Action）
  const {
    data: entities = [],
    isLoading,
    refetch,
  } = useQuery({
    queryKey: ["entities"],
    queryFn: async () => {
      const res = await listEntitiesAction();
      return res.success ? res.data : [];
    },
    staleTime: 0,
  });

  // ✅ 创建 Mutation（调用 Server Action）
  const createEntityMutation = useMutation({
    mutationFn: createEntityAction,
    onSuccess: (res) => {
      if (res.success) {
        queryClient.invalidateQueries({ queryKey: ["entities"] });
      }
    },
    onError: (error) => {
      console.error("创建失败:", error);
    },
  });

  // ✅ 删除 Mutation
  const deleteEntityMutation = useMutation({
    mutationFn: deleteEntityAction,
    onSuccess: (res) => {
      if (res.success) {
        queryClient.invalidateQueries({ queryKey: ["entities"] });
      }
    },
    onError: (error) => {
      console.error("删除失败:", error);
    },
  });

  return {
    entities,
    isLoading,
    refetch,
    createEntityMutation,
    deleteEntityMutation,
  };
}
```

## 页面使用示例

```tsx
"use client";

import { useCallback } from "react";
import { toast } from "sonner";
import { useTopLoader } from "nextjs-toploader";
import { useEntities } from "@/hooks/use-entities";

export default function EntitiesPage() {
  const { start, done } = useTopLoader();
  const { entities, isLoading, createEntityMutation } = useEntities();

  const handleCreate = useCallback(
    async (data: EntityFormData) => {
      start();
      try {
        const res = await createEntityMutation.mutateAsync(data);
        if (res.success) {
          toast.success("创建成功");
        } else {
          toast.error(res.error || "创建失败");
        }
      } finally {
        done();
      }
    },
    [createEntityMutation] // ⚠️ 不添加 start/done
  );

  return (
    <EntityForm
      onSubmit={handleCreate}
      isLoading={createEntityMutation.isPending}
    />
  );
}
```

## 检查清单

- [ ] 使用 `useMutation` from `@tanstack/react-query`
- [ ] `mutationFn` 调用 Server Action（不是 fetch）
- [ ] `onSuccess` 检查 `res.success` 并刷新 queryKey
- [ ] `onError` 记录错误
- [ ] 返回 mutation 实例供组件使用
- [ ] 使用 `mutation.isPending` 而非 `isLoading`

## 禁止事项

- ❌ 使用 fetch('/api/...') 获取数据
- ❌ 自定义 mutation 对象（手动管理 isLoading/error）
- ❌ 不使用 `useMutation`
- ❌ 缺少 `onSuccess` 或 `onError`
- ❌ 使用 `isLoading` 而非 `isPending`
