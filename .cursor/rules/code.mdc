---
description: 项目代码开发总体规范 - 适用于所有代码文件
globs:
alwaysApply: true
---

# 项目代码开发规范

## 技术栈

- **框架**: Next.js 16 (App Router) + React 19 + TypeScript
- **数据库**: Drizzle ORM + PostgreSQL
- **状态管理**: TanStack React Query (服务端) + Zustand (客户端) + nuqs (URL)
- **UI**: Radix UI + Tailwind CSS + shadcn/ui
- **表单**: React Hook Form + Zod
- **提示**: sonner (toast) + nextjs-toploader (加载条)

## 项目结构

```
app/(platform)/          # 平台页面（需登录）
components/              # 共享组件
  ui/                    # shadcn/ui 基础组件
  data-table/            # 表格组件
  shared/                # 业务共享组件
hooks/                   # 自定义 Hooks (use-{domain}.ts)
server/
  actions/               # Server Actions ({entity}Action.ts)
  db/schema/             # Drizzle Schema
types/                   # 类型定义 ({domain}-types.ts)
lib/                     # 工具函数
```

## 导入顺序（强制）

```tsx
// 1. React
import * as React from "react";
import { useState, useEffect, useMemo, useCallback } from "react";

// 2. Next.js
import { useRouter } from "next/navigation";

// 3. Third-party
import { toast } from "sonner";
import { useTopLoader } from "nextjs-toploader";
import { useMutation, useQuery } from "@tanstack/react-query";

// 4. UI Components
import { Button } from "@/components/ui/button";

// 5. Business Components
import PageContainer from "@/components/page-container";

// 6. Hooks
import { useEntities } from "@/hooks/use-entities";

// 7. Server Actions
import { createEntity } from "@/server/actions/entityAction";

// 8. Types
import type { Entity } from "@/types/entity-types";
```

## 组件结构（强制）

```tsx
export default function Component() {
  // 1. Hooks
  const router = useRouter();
  const { start, done } = useTopLoader();

  // 2. State
  const [value, setValue] = useState("");

  // 3. Memoized values
  const filtered = useMemo(() => data.filter(...), [data]);

  // 4. Callbacks
  const handleSubmit = useCallback(async () => {
    start();
    try { ... } finally { done(); }
  }, [/* 不包含 start/done */]);

  // 5. Effects
  useEffect(() => { ... }, []);

  // 6. Render
  return <div>...</div>;
}
```

## 核心规则

### 路径别名
- ✅ 使用 `@/` 路径别名
- ❌ 禁止使用相对路径 `../../../`

### 加载状态
- ✅ 使用 `useTopLoader` 的 `start()`/`done()`
- ⚠️ **禁止** 将 `start`/`done` 添加到 `useCallback` 依赖（会导致死循环）

### Toast 提示
- ✅ 使用 `sonner` 的 `toast.success()`/`toast.error()`
- ✅ 根据 `res.success` 显示不同提示

### Mutation 状态
- ✅ 使用 `mutation.isPending`
- ❌ 禁止使用 `isLoading`

### 性能优化
- ✅ 表格列定义使用 `useMemo`
- ✅ 回调函数使用 `useCallback`
- ✅ 复杂计算使用 `useMemo`
