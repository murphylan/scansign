---
description: Server Actions 开发规范 - 适用于 server/actions 目录下的文件
globs:
  - server/actions/**/*.ts
---

# Server Actions 规范

> **重要**: 页面必须通过 Hooks + Server Actions 访问数据，禁止使用 fetch('/api/...')

## 文件规范

- **位置**: `server/actions/` 目录
- **命名**: `{entity}Action.ts`（如 `checkinAction.ts`）
- **指令**: 文件顶部必须有 `"use server";`

## 返回格式（强制）

所有 Server Action 必须返回统一格式：

```typescript
{ success: boolean, data?: T, error?: string }
```

## 标准模板

```typescript
"use server";

import { randomUUID } from "crypto";
import { revalidatePath } from "next/cache";
import { eq, desc, and, sql } from "drizzle-orm";
import { db } from "@/server/db";
import { entities } from "@/server/db/schema";
import { getCurrentUser } from "./authAction";

export async function listEntitiesAction() {
  try {
    const user = await getCurrentUser();
    if (!user) {
      return { success: false, error: "未登录" };
    }

    const list = await db
      .select()
      .from(entities)
      .where(eq(entities.userId, user.id))
      .orderBy(desc(entities.createdAt));

    return { success: true, data: list };
  } catch (error) {
    console.error("Failed to list entities:", error);
    return { success: false, error: "获取列表失败" };
  }
}

export async function createEntityAction(data: EntityFormData) {
  try {
    const user = await getCurrentUser();
    if (!user) {
      return { success: false, error: "未登录" };
    }

    const [entity] = await db
      .insert(entities)
      .values({
        id: randomUUID(),
        ...data,
        userId: user.id,
        createdAt: new Date(),
        updatedAt: new Date(),
      })
      .returning();

    revalidatePath("/entities");
    return { success: true, data: entity };
  } catch (error) {
    console.error("Failed to create entity:", error);
    return { success: false, error: "创建失败" };
  }
}

export async function deleteEntityAction(id: string) {
  try {
    const user = await getCurrentUser();
    if (!user) {
      return { success: false, error: "未登录" };
    }

    await db.delete(entities).where(eq(entities.id, id));

    revalidatePath("/entities");
    return { success: true };
  } catch (error) {
    console.error("Failed to delete entity:", error);
    return { success: false, error: "删除失败" };
  }
}
```

## 检查清单

- [ ] 文件顶部有 `"use server";`
- [ ] 使用 `getCurrentUser()` 检查登录状态
- [ ] 返回格式为 `{ success, data?, error? }`
- [ ] 使用 try-catch 捕获异常
- [ ] 使用 `revalidatePath()` 刷新缓存
- [ ] 使用 Drizzle ORM（不是 Prisma）
- [ ] 多条件查询使用 `and()` 合并

## 命名约定

| 操作 | 函数名后缀 | 示例 |
|------|-----------|------|
| 获取列表 | `list...Action` | `listCheckinsAction` |
| 获取单个 | `get...Action` | `getCheckinAction` |
| 创建 | `create...Action` | `createCheckinAction` |
| 更新 | `update...Action` | `updateCheckinAction` |
| 删除 | `delete...Action` | `deleteCheckinAction` |

## 禁止事项

- ❌ 返回格式不是 `{ success, data, error }`
- ❌ 不使用 try-catch
- ❌ 不检查用户登录状态
- ❌ 使用 Prisma（项目使用 Drizzle ORM）
- ❌ 链式调用多个 `.where()`（使用 `and()` 代替）
