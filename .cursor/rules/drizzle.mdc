---
description: Drizzle ORM æ•°æ®åº“è§„èŒƒ - é€‚ç”¨äºæ•°æ®åº“ç›¸å…³æ–‡ä»¶
globs:
  - server/db/**/*.ts
  - server/actions/**/*.ts
---

# Drizzle ORM è§„èŒƒ

> **é‡è¦**: æœ¬é¡¹ç›®**åªä½¿ç”¨ Drizzle ORM**ï¼Œç¦æ­¢ä½¿ç”¨ Prismaï¼

## é¡¹ç›®ç»“æ„

```
src/server/
â”œâ”€â”€ db/
â”‚   â”œâ”€â”€ index.ts          # æ•°æ®åº“è¿æ¥
â”‚   â””â”€â”€ schema/           # Schema å®šä¹‰
â”‚       â”œâ”€â”€ index.ts      # å¯¼å‡ºæ‰€æœ‰è¡¨
â”‚       â”œâ”€â”€ users.ts      # ç”¨æˆ·ç›¸å…³è¡¨
â”‚       â”œâ”€â”€ checkins.ts   # ç­¾åˆ°ç›¸å…³è¡¨
â”‚       â”œâ”€â”€ votes.ts      # æŠ•ç¥¨ç›¸å…³è¡¨
â”‚       â”œâ”€â”€ forms.ts      # è¡¨å•ç›¸å…³è¡¨
â”‚       â””â”€â”€ lotteries.ts  # æŠ½å¥–ç›¸å…³è¡¨
â””â”€â”€ actions/              # Server Actions
```

## Schema å®šä¹‰

ä½ç½®: `server/db/schema/{entity}.ts`

```typescript
import { pgTable, pgSchema, text, timestamp, boolean, integer, jsonb } from "drizzle-orm/pg-core";

// ä½¿ç”¨ tool schema
export const toolSchema = pgSchema("tool");

// æšä¸¾å®šä¹‰
export const statusEnum = toolSchema.enum("Status", ["DRAFT", "ACTIVE", "PAUSED", "ENDED"]);

// è¡¨å®šä¹‰
export const entities = toolSchema.table("Entity", {
  id: text("id").primaryKey(),
  code: text("code").notNull().unique(),
  title: text("title").notNull(),
  status: statusEnum("status").default("DRAFT").notNull(),
  config: jsonb("config").default({}).notNull(),
  userId: text("userId").notNull().references(() => users.id, { onDelete: "cascade" }),
  createdAt: timestamp("createdAt").defaultNow().notNull(),
  updatedAt: timestamp("updatedAt").defaultNow().notNull(),
});
```

## æŸ¥è¯¢æ“ä½œ

### å¯¼å…¥

```typescript
import { db } from "@/server/db";
import { entities } from "@/server/db/schema";
import { eq, and, or, desc, asc, sql, gt, lt, isNull, inArray } from "drizzle-orm";
```

### æŸ¥è¯¢å•æ¡

```typescript
const [entity] = await db
  .select()
  .from(entities)
  .where(eq(entities.id, id))
  .limit(1);

return entity || null;
```

### æŸ¥è¯¢åˆ—è¡¨

```typescript
const results = await db
  .select()
  .from(entities)
  .where(eq(entities.status, "ACTIVE"))
  .orderBy(desc(entities.createdAt));
```

### ğŸ”´ å¤šæ¡ä»¶æŸ¥è¯¢ï¼ˆé‡è¦ï¼ï¼‰

**ç¦æ­¢é“¾å¼è°ƒç”¨å¤šä¸ª `.where()`ï¼Œå¿…é¡»ä½¿ç”¨ `and()` åˆå¹¶æ¡ä»¶ï¼š**

```typescript
// âŒ é”™è¯¯ï¼šé“¾å¼è°ƒç”¨å¤šä¸ª whereï¼ˆä¼šå¯¼è‡´ç¼–è¯‘é”™è¯¯ï¼‰
const [record] = await db
  .select()
  .from(records)
  .where(eq(records.entityId, entityId))
  .where(eq(records.phone, phone))
  .limit(1);

// âœ… æ­£ç¡®ï¼šä½¿ç”¨ and() åˆå¹¶æ¡ä»¶
const [record] = await db
  .select()
  .from(records)
  .where(
    and(
      eq(records.entityId, entityId),
      eq(records.phone, phone)
    )
  )
  .limit(1);
```

### æ’å…¥

```typescript
import { randomUUID } from "crypto";

const [inserted] = await db
  .insert(entities)
  .values({
    id: randomUUID(),
    code: generateCode(),
    title: data.title,
    status: "ACTIVE",
    userId: user.id,
    createdAt: new Date(),
    updatedAt: new Date(),
  })
  .returning();
```

### æ›´æ–°

```typescript
const [updated] = await db
  .update(entities)
  .set({
    title: data.title,
    updatedAt: new Date(),
  })
  .where(eq(entities.id, id))
  .returning();
```

### ä½¿ç”¨ SQL è¡¨è¾¾å¼æ›´æ–°è®¡æ•°

```typescript
import { sql } from "drizzle-orm";

await db
  .update(entities)
  .set({
    totalCount: sql\`\${entities.totalCount} + 1\`,
    updatedAt: new Date(),
  })
  .where(eq(entities.id, id));
```

### åˆ é™¤

```typescript
await db.delete(entities).where(eq(entities.id, id));
```

## å¸¸ç”¨æ“ä½œç¬¦

| æ“ä½œç¬¦ | ç”¨é€” | ç¤ºä¾‹ |
|--------|------|------|
| `eq` | ç­‰äº | `eq(entities.id, id)` |
| `and` | ä¸ï¼ˆåˆå¹¶æ¡ä»¶ï¼‰ | `and(eq(...), eq(...))` |
| `or` | æˆ– | `or(eq(...), eq(...))` |
| `desc` | é™åº | `desc(entities.createdAt)` |
| `asc` | å‡åº | `asc(entities.order)` |
| `gt` | å¤§äº | `gt(entities.count, 0)` |
| `sql` | åŸç”Ÿ SQL | \`sql\`\${entities.count} + 1\`\` |

## æ£€æŸ¥æ¸…å•

- [ ] ä½¿ç”¨ `randomUUID()` ç”Ÿæˆä¸»é”® ID
- [ ] ä½¿ç”¨ `.returning()` è·å–æ“ä½œç»“æœ
- [ ] ä½¿ç”¨ `and()` åˆå¹¶å¤šä¸ªæŸ¥è¯¢æ¡ä»¶
- [ ] æ­£ç¡®å¤„ç† null å€¼

## ç¦æ­¢äº‹é¡¹

- âŒ ä½¿ç”¨ Prismaï¼ˆé¡¹ç›®ä½¿ç”¨ Drizzle ORMï¼‰
- âŒ é“¾å¼è°ƒç”¨å¤šä¸ª `.where()`ï¼ˆä½¿ç”¨ `and()` ä»£æ›¿ï¼‰
- âŒ å¿˜è®° `.returning()` è·å–ç»“æœ
